var nodes_data = [
	{
	"name": "CC1",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC2",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC3",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC4",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC5",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC6",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC7",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC8",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC9",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC10",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC11",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC12",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC13",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC14",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC15",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC16",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC17",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC18",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC19",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	},
	{
	"name": "CC20",
	"type": "change",
	"attributes": [
			{"name":"Amanda Rosado",
			 "attribute":"developer testing"},
			{"name":"Jacob VanEck",
			 "attribute":"code review"},
			{"name":"45s",
			 "attribute":"uat time"},
			{"name":"NEDS",
			 "attribute":"system"},
			{"name":"Candy Smith",
			 "attribute":"user testing"}
		]
	}
];

var graph = d3.select('#graph');
var info_panel = d3.select('#panel');

// var width = 960; 
// var height = 500;
var widthPercent = parseFloat(graph.style("width"))/window.innerWidth;
var width = (widthPercent * window.innerWidth);
var height = window.innerHeight - 20; 
var radius = 50;
var small_radius = radius * (2/4);
var node_color = "#BBDD44";
var link_distance = small_radius * 3.1;
var loose_link_distance = radius * 12;

var allNodes = [];
var ccNodes = [];
var attributeNodes = [];
var links_data = [];

var focus;

var svg = graph.append('svg')
	.attr('width', width)
	.attr('height', height);

// Populate CC Array
nodes_data.map(function(entry){
    var cc = {};
    cc.ccname = entry.name;
    cc.name = entry.name;
    cc.label = entry.name;
    cc.type = entry.type;
    cc.attributes = entry.attributes;

    ccNodes.push(cc);
});

// Populate each CC's attribute array and link each attribute to its CC
ccNodes.forEach(function(ccNode){
	ccNode.attributes.map(function(entry){
		var atrb = {};
		atrb.ccname = ccNode.name;
		atrb.name = ccNode.name + entry.attribute + entry.name;
		atrb.label = entry.name;
		atrb.type = "attribute";
		atrb.attribute = entry.attribute;
		attributeNodes.push(atrb);

		var link = {};

		link.source = ccNode.name;
		link.target = atrb.name;
		link.type = "";

		links_data.push(link);
	});
});

// Link each CC node to all the others
for(var i = 0; i < ccNodes.length - 1; i++){
	for(var j = 1; j < ccNodes.length; j++){
		var link = {};

		link.source = ccNodes[i].name;
		link.target = ccNodes[j].name;
		link.type = "loose";

		links_data.push(link);
	}
}

// Link each CC node to just the next one
// var lastCCNode;
// for(var i = 0; i < ccNodes.length; i++){
// 	if(lastCCNode != null){
// 		var biglink = {};
// 		biglink.source = ccNodes[i];
// 		biglink.target = lastCCNode;
// 		biglink.type = "big";
// 		links_data.push(biglink);
// 	}
// 	lastCCNode = ccNodes[i];
// }
// var biglink = {};
// biglink.source = ccNodes[0];
// biglink.target = lastCCNode;
// biglink.type = "big";
// links_data.push(biglink);


// // Link each CC node's attributes to each other with the same CC
// for(var i = 0; i < ccNodes.length; i++){
// 	for(var a = 0; a < ccNodes[i].attributes.length - 1; a++){
// 		for(var b = 1; b < ccNodes[i].attributes.length; b++){
// 			var link = {};

// 			link.source = ccNodes[i].name + ccNodes[i].attributes[a].attribute + ccNodes[i].attributes[a].name;
// 			link.target = ccNodes[i].name + ccNodes[i].attributes[b].attribute + ccNodes[i].attributes[b].name;
// 			link.type = "";

// 			links_data.push(link);
// 		}
// 	}
// }

// // V2 - Link each CC node's attributes to the NEXT with the same CC
// for(var i = 0; i < ccNodes.length; i++){
// 	var lastAtrbNode;
// 	for(var a = 0; a < ccNodes[i].attributes.length; a++){
// 		if(lastAtrbNode != null){
// 			var link = {};

// 			link.source = ccNodes[i].name + ccNodes[i].attributes[a].attribute + ccNodes[i].attributes[a].name;
// 			link.target = ccNodes[i].name + lastAtrbNode.attribute + lastAtrbNode.name;
// 			link.type = "";

// 			links_data.push(link);
// 		}
// 		lastAtrbNode = ccNodes[i].attributes[a];
// 	}
// 	var link = {};
// 	link.source = ccNodes[i].attributes[0];
// 	link.target = lastAtrbNode;
// 	link.type = "";
// 	links_data.push(link);
// }

allNodes = ccNodes.concat(attributeNodes);

var linkSelection = svg.append("g")
	.attr("class", "links")
	.selectAll("line")
	.data(links_data)
	.enter()
	.append("line")
	.attr("stroke-width", 2)
	.attr("class", function(d){
		if(d.type != "loose"){
			return "showlink";
		}
	});

var nodeSelection = svg.append("g")
	.attr("class", "nodes")
	.selectAll("circle")
	.data(allNodes)
	.enter()
	.append("circle")
	.attr("r", function(d) {
		if(d.type == "attribute")
			return small_radius;
		else
			return radius;
	})
	.attr("fill", node_color)
    .on("click", clicked)
	.attr("cx", width/2)
	.attr("cx", height/2);

var labelSelection = svg.append("g")
	.attr("class", "labels")
	.selectAll("text")
	.data(allNodes)
	.enter()
	.append("text")
	.text(function(d){ return d.label })
	.style("text-anchor", "middle");

var link_force = d3.forceLink(links_data)
	.id(function(d) { return d.name; })
	.distance(function(d) {
		if(d.type == "loose"){
			return loose_link_distance;
		}else{
			return link_distance;
		}
	});
	// .strength(function(d){
	// 	if(d.type == "loose"){
	// 		return .1;
	// 	}else{
	// 		return 1;
	// 	}
	// });

var simulation = d3.forceSimulation()
	.nodes(allNodes);

simulation
	.force("charge_force", d3.forceManyBody())
	.force("center_force", d3.forceCenter(width/2, height/2));

simulation.force("nodes", link_force);

function clicked(d){

	console.log("kjsafsd");
	if(focus != null && focus != d){
		deselectAll();
		focus = null;
	}
	if(focus == null){
		focus = d;
		info_panel.classed("hidden", false);
		d3.select(this).raise().classed("active", true);
		var ccNameSpan = $("#ccName");
		ccNameSpan.text("CCName: " + d.ccname);
	}else{
		focus = null;
		info_panel.classed("hidden", true);
		d3.select(this).raise().classed("active", false);
	}
}

function deselectAll(){
	d3.select(".active").classed("active", false);
}

function tick(){
	nodeSelection
		.attr("cx", function(d) { return d.x; }) // = Math.max(radius, Math.min(width - radius, d.x)); })
        .attr("cy", function(d) { return d.y; }); // = Math.max(radius, Math.min(height - radius, d.y)); });

	labelSelection
		.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return d.y; });

	linkSelection
		.attr("x1", function(d) { return d.source.x; })
		.attr("y1", function(d) { return d.source.y; })
		.attr("x2", function(d) { return d.target.x; })
		.attr("y2", function(d) { return d.target.y; });
}

simulation.on("tick", tick);